generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =============================================
// USERS & AUTH
// =============================================

model User {
  user_id         String  @id @db.Uuid
  email           String  @unique
  username String? @unique
  avatar_url      String?
  roles           UserRole[]
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
  is_active       Boolean  @default(true)

  // Relaciones
  maintainer_profile  MaintainerProfile?
  contributor_profile ContributorProfile?
  admin_profile       AdminProfile?
  project_maintainers ProjectMaintainer[]
  project_reviews     ProjectReview[]
  wallets             Wallet[]
  escrows             Escrow[]
  campaign_registrations CampaignContributor[]

  @@index([roles])
  @@index([is_active])
  @@index([username])
  @@map("user")
}

model MaintainerProfile {
  user_id      String   @id @db.Uuid
  bio          String?
  social_media Json?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  user User @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@map("maintainer_profile")
}

model ContributorProfile {
  user_id       String   @id @db.Uuid
  skills        String[]
  bio           String?
  portfolio_url String?
  social_media  Json?
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  user User @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([skills])
  @@map("contributor_profile")
}

model AdminProfile {
  user_id    String   @id @db.Uuid
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user User @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@map("admin_profile")
}

// =============================================
// WALLETS
// =============================================

model Wallet {
  wallet_id  String   @id @default(uuid()) @db.Uuid
  user_id    String   @db.Uuid
  address    String
  role       UserRole
  is_primary Boolean  @default(false)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user User @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@unique([user_id, address, role]) 
  @@index([user_id])
  @@index([address])
  @@index([user_id, role])
  @@map("wallet")
}

// =============================================
// PROJECTS
// =============================================

model Project {
  project_id        String          @id @default(uuid()) @db.Uuid
  name              String
  github_handle     String
  short_description String
  description       String          @db.Text
  tech_stack        String[]
  category          ProjectCategory
  status            ProjectStatus   @default(PENDING)
  created_by        String          @db.Uuid
  created_at        DateTime        @default(now())
  updated_at        DateTime        @updatedAt
  reviewed_at       DateTime?
  resubmission_count Int            @default(0)

  repositories Repository[]
  maintainers  ProjectMaintainer[]
  reviews      ProjectReview[]

  @@index([status])
  @@index([category])
  @@index([created_by])
  @@index([status, created_at])
  @@map("project")
}

model Repository {
  github_repo_id BigInt   @id
  project_id String   @db.Uuid
  github_url String
  name  String
  description    String?
  is_active Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  project   Project              @relation(fields: [project_id], references: [project_id], onDelete: Cascade)
  campaigns CampaignRepository[]

  @@index([project_id])
  @@index([is_active])
  @@map("repository")
}

model ProjectMaintainer {
  id           String   @id @default(uuid()) @db.Uuid
  project_id   String   @db.Uuid
  maintainer_id String   @db.Uuid
  is_owner     Boolean  @default(false)
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  is_active    Boolean  @default(true)

  project    Project @relation(fields: [project_id], references: [project_id], onDelete: Cascade)
  maintainer User    @relation(fields: [maintainer_id], references: [user_id], onDelete: Cascade)

  @@unique([project_id, maintainer_id])
  @@index([project_id])
  @@index([maintainer_id])
  @@map("project_maintainer")
}

// =============================================
// PROJECT REVIEWS
// =============================================

model ProjectReview {
  review_id  String       @id @default(uuid()) @db.Uuid
  project_id String       @db.Uuid
  admin_id   String       @db.Uuid
  action     ReviewAction
  reason     String?      @db.Text
  created_at DateTime     @default(now())
  updated_at DateTime     @updatedAt

  project Project @relation(fields: [project_id], references: [project_id], onDelete: Cascade)
  admin   User    @relation(fields: [admin_id], references: [user_id])

  @@index([project_id])
  @@index([admin_id])
  @@index([created_at])
  @@map("project_review")
}

model Campaign {
  campaign_id String @id @default(uuid()) @db.Uuid
  name        String
  description String
  tags        String[]
  start_date  DateTime
  end_date    DateTime
  status      CampaignStatus @default(PENDING)
  image_url   String?
  created_by  String @db.Uuid
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  repositories CampaignRepository[]
  escrows      Escrow[]
  contributors CampaignContributor[]

  @@index([tags])
  @@index([status])
  @@index([created_by])
  @@index([status, start_date])
  @@map("campaign")
}

model CampaignRepository {
  campaign_id   String   @db.Uuid
  repository_id BigInt
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  campaign   Campaign   @relation(fields: [campaign_id], references: [campaign_id], onDelete: Cascade)
  repository Repository @relation(fields: [repository_id], references: [github_repo_id], onDelete: Cascade)

  @@id([campaign_id, repository_id])
  @@index([campaign_id])
  @@index([repository_id])
  @@map("campaign_repository")
}

model CampaignContributor {
  id             String   @id @default(uuid()) @db.Uuid
  campaign_id    String   @db.Uuid
  contributor_id String   @db.Uuid
  registered_at  DateTime @default(now())

  campaign    Campaign @relation(fields: [campaign_id], references: [campaign_id], onDelete: Cascade)
  contributor User     @relation(fields: [contributor_id], references: [user_id], onDelete: Cascade)

  @@unique([campaign_id, contributor_id])
  @@index([campaign_id])
  @@index([contributor_id])
  @@map("campaign_contributor")
}

// =============================================
// ESCROWS
// =============================================

model Escrow {
  escrow_id   String     @id @db.Uuid
  escrow_type EscrowType
  campaign_id String     @db.Uuid
  created_by  String     @db.Uuid
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt

  campaign   Campaign @relation(fields: [campaign_id], references: [campaign_id], onDelete: Cascade)
  created_by_user User @relation(fields: [created_by], references: [user_id], onDelete: Cascade)

  @@index([campaign_id])
  @@index([created_by])
  @@index([escrow_type])
  @@map("escrow")
}

// =============================================
// ENUMS
// =============================================

enum UserRole {
  ADMIN
  MAINTAINER
  CONTRIBUTOR
}

enum ProjectStatus {
  PENDING
  APPROVED
  REJECTED
  CHANGES_REQUESTED
}

enum ProjectCategory {
  DEFI
  NFT
  TOOLING
  PAYMENTS
  GAMING
  INFRASTRUCTURE
  OTHER
}

enum ReviewAction {
  APPROVED
  REJECTED
  CHANGES_REQUESTED
}

enum CampaignStatus {
  PENDING
  UPCOMING
  ACTIVE
  INACTIVE
}

enum EscrowType {
  MAINTAINER
  CONTRIBUTOR
}
